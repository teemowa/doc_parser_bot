# Бот для анализа PDF-документов

Telegram-бот для автоматического анализа PDF-документов с использованием машинного обучения. Бот обнаруживает подписи, QR-коды и печати на страницах документа, создает визуальные отчеты и предоставляет структурированные данные о найденных объектах.

## Основные функции

1. Детекция объектов на страницах документа:
   - Подписи
   - QR-коды
   - Печати и штампы

2. Генерация PDF-отчета с визуальными рамками вокруг найденных объектов

3. Создание тепловой карты для визуализации расположения объектов

4. Предоставление JSON-файла с координатами всех обнаруженных объектов

## Архитектура

Проект построен на микросервисной архитектуре с использованием Docker Compose:

- telegram_bot: Сервис Telegram-бота (python-telegram-bot), управляет взаимодействием с пользователем
- ml_service: FastAPI сервис с моделями машинного обучения для детекции объектов

## Технологический стек

- Python
- FastAPI (ML-сервис)
- python-telegram-bot (интерфейс бота)
- Docker Compose (оркестрация)
- PyMuPDF (обработка PDF)
- PyTorch (машинное обучение)

## Используемые модели

Все модели работают в едином PyTorch окружении:

1. Подписи: tech4humans/yolov8s-signature-detector
2. QR-коды: qrdet (модель 'l') с предобработкой изображений
3. Печати: Ooredoo-Group/ooredoo-stamp-detection
4. Таблицы: отключены

### Особенности детекции QR-кодов

- Увеличение разрешения изображения в 2.5 раза
- Адаптивное масштабирование для маленьких изображений
- Предобработка: Unsharp Mask и CLAHE для улучшения контраста
- Расширение границ для мелких QR-кодов

## Установка и запуск

### Требования

- Docker и Docker Compose
- Токен Telegram-бота

### Инструкция

1. Клонируйте репозиторий:
```bash
git clone [URL-вашего-репозитория]
cd doc_parser_bot
```

2. Создайте файл .env в корневой папке проекта:
```bash
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

3. Соберите Docker-образы:
```bash
docker compose build
```

4. Запустите проект:
```bash
docker compose up -d
```

5. Проверьте логи:
```bash
docker compose logs -f
```

## Использование

1. Найдите вашего бота в Telegram
2. Отправьте PDF-документ для анализа
3. Получите три файла:
   - PDF-отчет с визуальными рамками
   - Изображение тепловой карты
   - JSON-файл с координатами объектов

## Структура проекта

```
doc_parser_bot/
├── telegram_bot/          # Сервис Telegram-бота
│   ├── main.py
│   ├── requirements.txt
│   └── Dockerfile
├── ml_service/            # ML-сервис для детекции
│   ├── main.py
│   ├── requirements.txt
│   ├── Dockerfile
│   └── local_models/      # Резервные модели
├── docker-compose.yml
├── .env                   # Конфигурация (не в git)
└── README.md
```

## Настройка параметров

Параметры детекции можно настроить через переменные окружения в .env файле:

```bash
# Пороги уверенности (0.0 - 1.0)
SIGNATURE_CONF=0.15
QR_CONF=0.3
STAMP_CIRCULAR_CONF=0.20

# Параметры QR детекции
QR_UPSCALE_FACTOR=2.5
QR_ENHANCE_IMAGE=true
QR_MODEL_SIZE=l
```

## Обновление на сервере

1. Закоммитьте изменения:
```bash
git add .
git commit -m "описание изменений"
git push origin main
```

2. На сервере выполните:
```bash
git pull origin main
docker compose down
docker compose build --no-cache
docker compose up -d
```

## Мониторинг

Просмотр логов всех сервисов:
```bash
docker compose logs -f
```

Просмотр логов конкретного сервиса:
```bash
docker compose logs -f ml-service
docker compose logs -f telegram-bot
```

Проверка статуса:
```bash
docker compose ps
```

## Остановка

```bash
docker compose down
```

## Примечания

- Модели автоматически скачиваются при первом запуске
- Кэш моделей сохраняется в Docker volume для ускорения последующих запусков
- Локальные модели в local_models/ используются как резервные при проблемах с загрузкой
